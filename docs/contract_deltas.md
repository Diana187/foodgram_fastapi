# contract_deltas.md

## Цель
Фиксировать **все отличия API FastAPI (v2)** от исходного **Django-контракта (v1)**, описанного в `openapi-schema.yml`.
Документ нужен, чтобы не «сломать фронт» при миграции и прозрачно отслеживать все изменения API.

---

## Δ v1 → v2 (FastAPI миграция)

### Общие изменения
- [note] Базовый контракт сохранён без изменений (`openapi-schema.yml` перенесён из Django).
- [note] Новые эндпоинты и поля фиксируются ниже, по разделам.
- [note] Все ответы по умолчанию в формате JSON; пагинация и фильтры — как в v1.

---

### Users
- [note] Авторизация реализуется через **JWT-куки (AuthX)** вместо `djoser` токенов.
- [note] Все маршруты `/auth/token/login/`, `/auth/token/logout/` сохранены для совместимости.
- [added] Поле `is_active` теперь явно возвращается в `/users/me/`.
- [changed] Поле `password` больше не присутствует ни в одном ответе (только при создании/изменении).
- [planned] добавить `/users/verify/` для email-верификации (опционально).

---

### Recipes
- [note] Эндпоинты `/recipes/`, `/recipes/{id}/`, `/recipes/favorite/`, `/recipes/shopping_cart/` сохранены.
- [changed] Логика сериализации `Recipe` перенесена в Pydantic-модели (названия полей без изменений).
- [changed] Связи с пользователем теперь реализованы через `ForeignKey(..., ondelete="CASCADE")`.
- [note] Параметры фильтрации (`?is_favorited`, `?author`, `?tags`) сохранены.
- [planned] добавить асинхронную фильтрацию ингредиентов внутри рецептов.

---

### Ingredients
- [note] Эндпоинт `/ingredients/` сохранён.
- [changed] Поиск теперь выполняется через `ILIKE` (регистронезависимо).
- [changed] Поле `measurement_unit` может быть объединено с `unit` (уточнить в контракте v2).
- [planned] сиды для таблицы `ingredient` загружаются при первой миграции.

---

### Tags
- [note] `/tags/` и `/tags/{id}/` без изменений.
- [planned] добавить цветовое поле `color_hex` (`String(7)`).

---

### Favorites / ShoppingCart
- [note] Оба эндпоинта сохранили формат (`user+recipe` уникальная пара).
- [changed] Возвращаемый ответ теперь — `RecipeShort` (без избыточных полей).
- [note] ondelete='CASCADE' на уровне FK для очистки при удалении пользователя.

---

### Follows
- [note] `/users/subscriptions/` и `/users/{id}/subscribe/` сохранены.
- [changed] Связь `user → author` через таблицу `follow` с уникальной парой.
- [planned] добавить ограничение `max_subscriptions_per_user` в бизнес-логике.

---

## Δ v2 → v3 (резерв под будущее)
*(создаётся при изменениях после первого релиза FastAPI-версии)*

---

## Принципы ведения
- ⚠️ **Не удаляем** старые записи — добавляем новые блоки сверху.
- Каждая секция помечается:
  - `[added]` — новое поле или эндпоинт
  - `[removed]` — удалено
  - `[changed]` — изменено
  - `[note]` — пояснение
  - `[planned]` — запланировано
- Все изменения должны ссылаться на номер версии схемы или commit-id миграции.
- При изменении схемы — обновлять `openapi-schema.yml` и дописывать дельту сюда.
