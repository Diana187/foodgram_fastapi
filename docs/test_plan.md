# test_plan.md

## Цель
Минимальный набор e2e/интеграционных тестов для первой итерации миграции (без ломки контракта): **аутентификация, CRUD рецептов, фильтры/пагинация, избранное/корзина/подписки, загрузка файла, экспорт списка покупок, типичные ошибки**.

## Общие условия
- База: тестовый Postgres, пустая + сиды ингредиентов/тегов.
- Пользователи:
  - `user1` (обычный), `user2` (автор рецепта), `admin` (если нужен).
- Токены: получать через `/api/auth/token/login/`.
- Заголовки для защищённых запросов: `Authorization: Token <token>`.

---

## 1) Аутентификация

### 1.1 Логин
- `POST /api/auth/token/login/` с валидными `email/password` → **200**, тело `{"auth_token": "..."}`.
- Невалидные креды → **400** (или 401 по реализации Djoser).
- Пустой payload → **400**.

### 1.2 Logout
- `POST /api/auth/token/logout/` с валидным токеном → **204**.
- Без токена → **401**.

### 1.3 Профиль
- `GET /api/users/me/` с токеном → **200**, корректные поля (`email`, `username`, …).
- Без токена → **401**.

### 1.4 Регистрация
- `POST /api/users/` валидные поля → **201**, пользователь создан.
- Дубликат `email/username` → **400** (валидация уникальности).

---

## 2) CRUD рецептов

### 2.1 Создание
- `POST /api/recipes/` авторизованным:
  - валидный рецепт (минимум 1 тег, 1 ингредиент, `cooking_time >= 1`) → **201**, поля совпадают.
  - без тегов/ингредиентов → **400** (сообщение об ошибке).
  - `cooking_time <= 0` → **400**.
- Анонимно → **401**.

### 2.2 Чтение
- `GET /api/recipes/` → **200**, список, формат пагинации `{count,next,previous,results}`.
- `GET /api/recipes/{id}/` существующий → **200**.
- `GET /api/recipes/{id}/` несуществующий → **404**.

### 2.3 Обновление
- Автор рецепта `PUT/PATCH /api/recipes/{id}/` → **200**, изменения применены.
- Другой пользователь → **403**.
- Анонимно → **401**.

### 2.4 Удаление
- Автор `DELETE /api/recipes/{id}/` → **204**.
- Другой пользователь → **403**.
- Анонимно → **401**.

---

## 3) Фильтры и пагинация

### 3.1 Пагинация (PageNumber)
- `GET /api/recipes/?page=1&limit=6` → **200**, не более 6 элементов.
- `limit > 15` → принудительно **15** (max_page_size).
- `page` вне диапазона → **200** с пустым `results` (или корректная реакция фреймворка).

### 3.2 Поиск ингредиентов
- `GET /api/ingredients/?name=со` → **200**, только имена на `^со` (регистронезависимо).

### 3.3 Фильтрация рецептов
- `GET /api/recipes/?tags=breakfast&tags=lunch` → **200**, только рецепты с этими slug.
- `GET /api/recipes/?author={user2_id}` → **200**, рецепты автора.
- `GET /api/recipes/?is_favorited=1` (с токеном) → **200**, только избранное текущего пользователя.
- `GET /api/recipes/?is_in_shopping_cart=true` (с токеном) → **200**, только из корзины.
- Те же булевы параметры **без токена** → **200**, игнорируются (фактически весь список, как в коде).

### 3.4 Подписки: ограничение рецептов
- `GET /api/users/subscriptions/?recipes_limit=3&page=1` (с токеном) → **200**, в каждом объекте автора не более 3 рецептов.
- Без токена → **401**.

---

## 4) Избранное / Корзина / Подписки

### 4.1 Избранное
- `POST /api/recipes/{id}/favorite/` (с токеном) → **201**, в ответе корректные поля.
- Повторный `POST` → **400** (дубликат).
- `DELETE /api/recipes/{id}/favorite/` существующая запись → **204**.
- `DELETE` при отсутствии записи → **400** (сообщение об ошибке).
- Без токена → **401**.

### 4.2 Корзина
- Аналогично избранному:
  - `POST /api/recipes/{id}/shopping_cart/` → **201**; повтор → **400**.
  - `DELETE /api/recipes/{id}/shopping_cart/` → **204**; при отсутствии → **400**.
  - Без токена → **401**.

### 4.3 Подписки
- `POST /api/users/{author_id}/subscribe/` (с токеном) → **201**.
- Повторная подписка → **400**.
- Самоподписка → **400**.
- `DELETE /api/users/{author_id}/subscribe/` существующая → **204**.
- `DELETE` при отсутствии → **400**.
- `GET /api/users/subscriptions/` (с токеном) → **200**, пагинация, `recipes_limit` работает.
- Любой из этих запросов **без токена** → **401**.

---

## 5) Загрузка файла (image)

### 5.1 Base64 (совместимость)
- `POST /api/recipes/` с `image` в base64 → **201**, в ответе `image` присутствует (URL или строка в соответствии с политикой).
- Невалидный base64 → **400**.

### 5.2 Multipart (рекомендованный)
- `POST /api/recipes/` как `multipart/form-data` с полем `image` (`jpeg/png/webp`, ≤5MB) → **201**.
- Неподдерживаемый MIME/oversize → **422** или **400** (зафиксировать выбранный код; рекомендуем **422 Unprocessable Entity**).
- `PUT/PATCH` с заменой картинки → **200**, старое изображение больше не используется (по возможности проверить очистку).

---

## 6) Экспорт списка покупок

### 6.1 Успех
- `GET /api/recipes/download_shopping_cart/` (с токеном и непустой корзиной) → **200**:
  - заголовки: `Content-Type: text/plain`, `Content-Disposition: attachment; filename="shopping_list.txt"`
  - тело: текст «Купить:\n<name> (<unit>) - <quantity>…»
  - суммы по ингредиентам корректны.

### 6.2 Ошибки
- Пустая корзина → **400**, тело: `"В вашей корзине нет рецептов."`
- Без токена → **401**.

---

## 7) Типичные ошибки / статусы

| Сценарий | Эндпоинт | Ожидаемый статус |
|---|---|---|
| Без токена к защищённому | любой `IsAuthenticated` | **401** |
| Не автор правит чужой рецепт | `PUT/PATCH/DELETE /api/recipes/{id}/` | **403** |
| Объект не существует | `GET/PUT/DELETE /api/recipes/999999/` | **404** |
| Валидация модели | `POST /api/recipes/` без тегов/ингредиентов/`cooking_time<=0` | **400** |
| Дубликат избранного/корзины | `POST favorite/shopping_cart` второй раз | **400** |
| Отписка без подписки | `DELETE /api/users/{id}/subscribe/` | **400** |
| Неизвестный метод | Любой неподдерживаемый | **405** |
| Невалидный файл | загрузка image с плохим MIME/oversize | **422** или **400** (зафиксировать) |

---

## Данные/фикстуры (минимум)
- **Пользователи:** `user1`, `user2`.
- **Теги:** `breakfast`, `lunch` (slug-и).
- **Ингредиенты:** 5–10 из сидов (например: соль, сахар, молоко…).
- **Рецепты:** 3–5 рецептов `user2`, часть с `breakfast`, часть с `lunch`.
- **Связи для тестов:** избранные/корзина/подписки между `user1` и рецептами/автором.

---

## Нотации/утилиты
- Повторно используемый хелпер для авторизации (получение токена, добавление хедера).
- Матчинг ответов по схеме: проверка обязательных полей (`id`, `name`, `author`, `tags`, `ingredients`, `image`, `cooking_time`, `is_favorited`, `is_in_shopping_cart`).

---

## Критерии готовности (DoD первой итерации)
- Все кейсы в этом файле выполняются на тестовом окружении.
- Коды статусов и форматы ответов соответствуют описанию.
- Пагинация/фильтры/поиск работают в точности как в Django-версии.
- Загрузка изображений (base64 и multipart) покрыта тестами.
- Экспорт списка покупок генерирует корректный файл и ошибки.
